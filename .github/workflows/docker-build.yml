# ============================================
# GitHub Actions - Docker 自动构建
# 当代码推送到 main 分支或创建 tag 时自动构建
# ============================================

name: Docker Build & Push

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
  workflow_dispatch:  # 允许手动触发

env:
  # Docker 镜像名称
  API_IMAGE: lm-api
  WEB_IMAGE: lm-web

jobs:
  # ============================================
  # 读取版本号
  # ============================================
  version:
    name: Read Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_ENV

      - name: Show version
        run: |
          echo "Version: ${{ steps.version.outputs.version }}"

  # ============================================
  # 构建 API 镜像
  # ============================================
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    needs: version

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 安装 .NET SDK
      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # 配置 NuGet 镜像（国内加速）
      - name: Configure NuGet
        run: |
          mkdir -p ~/.nuget/
          cat > ~/.nuget/NuGet.Config <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <packageSources>
              <add key="huaweicloud" value="https://repo.huaweicloud.com/repository/nuget/v3/index.json" />
              <add key="nuget.org" value="https://api.nuget.org/v3/index.json" />
            </packageSources>
          </configuration>
          EOF

      # 恢复依赖
      - name: Restore dependencies
        run: |
          cd api/src/application/Poxiao.API.Entry
          dotnet restore

      # 发布 API
      - name: Publish API
        run: |
          cd api/src/application/Poxiao.API.Entry
          dotnet publish Poxiao.API.Entry.csproj \
            -c Release \
            -r linux-x64 \
            --self-contained false \
            -o ../../../../publish/api

      # 复制 resources
      - name: Copy resources
        run: |
          if [ -d "api/resources" ]; then
            cp -r api/resources publish/api/
          fi

      # 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 登录 Docker Hub（仅在配置了 Secrets 且 push 到 main 时）
      - name: Login to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 构建并推送镜像
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./api/Dockerfile.build
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.DOCKER_USERNAME != '' }}
          tags: |
            ${{ env.API_IMAGE }}:${{ needs.version.outputs.version }}
            ${{ env.API_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # 测试镜像
      - name: Test API image
        run: |
          docker images | grep ${{ env.API_IMAGE }} || echo "Image not found (expected if not built locally)"

  # ============================================
  # 构建 Web 镜像
  # ============================================
  build-web:
    name: Build Web Image
    runs-on: ubuntu-latest
    needs: version

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 安装 pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # 安装 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'web/pnpm-lock.yaml'

      # 配置 npm 镜像
      - name: Configure npm registry
        run: |
          pnpm config set registry https://registry.npmmirror.com

      # 安装依赖
      - name: Install dependencies
        run: |
          cd web
          pnpm install --frozen-lockfile

      # 构建前端
      - name: Build web
        run: |
          cd web
          pnpm build

      # 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 登录 Docker Hub（仅在配置了 Secrets 且 push 到 main 时）
      - name: Login to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 构建并推送镜像
      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./web/Dockerfile.build
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.DOCKER_USERNAME != '' }}
          tags: |
            ${{ env.WEB_IMAGE }}:${{ needs.version.outputs.version }}
            ${{ env.WEB_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # 测试镜像
      - name: Test Web image
        run: |
          docker images | grep ${{ env.WEB_IMAGE }} || echo "Image not found (expected if not built locally)"

  # ============================================
  # 构建成功通知
  # ============================================
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [version, build-api, build-web]
    if: always()

    steps:
      - name: Show summary
        run: |
          echo "=========================================="
          echo "构建完成！"
          echo "版本: ${{ needs.version.outputs.version }}"
          echo ""
          echo "镜像已构建（仅在 GitHub Actions 缓存）"
          echo "如需推送到 Docker Hub，请配置 Secrets:"
          echo "  - DOCKER_USERNAME"
          echo "  - DOCKER_PASSWORD"
          echo ""
          echo "API 镜像:"
          echo "  - lm-api:${{ needs.version.outputs.version }}"
          echo "  - lm-api:latest"
          echo ""
          echo "Web 镜像:"
          echo "  - lm-web:${{ needs.version.outputs.version }}"
          echo "  - lm-web:latest"
          echo "=========================================="
