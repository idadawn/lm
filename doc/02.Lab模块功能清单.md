# Lab 模块功能清单

## 模块概述

Lab 模块是实验室数据管理系统的核心模块，负责：
- 原始数据导入与解析
- 中间数据生成与公式计算
- 外观特性识别与管理
- 产品规格管理
- 单位换算系统

---

## 一、模块架构

```
Poxiao.Lab/                    # 服务实现层
├── Service/                   # 业务服务
└── Helpers/                   # 辅助工具

Poxiao.Lab.Entity/             # 实体层
├── Entity/                    # 数据库实体
├── Dto/                       # 数据传输对象
├── Enums/                     # 枚举定义
└── Attributes/                # 自定义特性

Poxiao.Lab.Interfaces/         # 接口层
└── *.cs                       # 服务接口定义
```

---

## 二、功能模块详解

### 2.1 原始数据导入模块

#### 核心服务

| 服务 | 文件 | 职责 |
|-----|------|------|
| RawDataImportSessionService | `RawDataImportSessionService.cs` | 多步骤导入会话管理 |
| RawDataService | `RawDataService.cs` | 原始数据 CRUD |
| RawDataValidationService | `RawDataValidationService.cs` | 数据校验 |
| ExcelImportTemplateService | `ExcelImportTemplateService.cs` | Excel 模板管理 |

#### 导入流程（4步）

```
Step 1: 上传/解析
  ↓ 上传 Excel 文件，解析表头和数据
Step 2: 产品规格匹配
  ↓ 根据炉号等信息匹配产品规格
Step 3: 外观特性匹配
  ↓ AI + 规则引擎识别外观特性
Step 4: 预览确认
  ↓ 用户确认后持久化数据
```

#### 相关实体

| 实体 | 表名 | 说明 |
|-----|------|------|
| RawDataEntity | LAB_RAW_DATA | 原始数据 |
| RawDataImportSessionEntity | LAB_RAW_DATA_IMPORT_SESSION | 导入会话 |
| RawDataImportLogEntity | LAB_RAW_DATA_IMPORT_LOG | 导入日志 |
| ExcelImportTemplateEntity | LAB_EXCEL_IMPORT_TEMPLATE | Excel 模板配置 |

---

### 2.2 中间数据模块

#### 核心服务

| 服务 | 文件 | 职责 |
|-----|------|------|
| IntermediateDataService | `IntermediateDataService.cs` | 中间数据生成、CRUD、公式计算 |
| IntermediateDataFormulaService | `IntermediateDataFormulaService.cs` | 公式维护 |
| IntermediateDataColorService | `IntermediateDataColorService.cs` | 颜色数据管理 |

#### 数据生成流程

```
原始数据 (RawData)
  ↓ 解析炉号（产线、班次、批次、卷号）
  ↓ 关联产品规格
  ↓ 执行 CALC 公式（计算指标）
  ↓ 执行 JUDGE 公式（判定结果）
中间数据 (IntermediateData)
```

#### 公式类型

| 类型 | 枚举值 | 说明 | 示例 |
|-----|-------|------|------|
| CALC | 1 | 计算公式 | `OneMeterWeight = Weight / Length` |
| JUDGE | 2 | 判定公式 | 条件规则 → 合格/不合格 |
| NO | 3 | 只展示 | 不参与计算 |

#### 判定公式结构

```json
// 简单规则
[{
  "resultValue": "合格",
  "rootGroup": {
    "logic": "AND",
    "conditions": [
      { "fieldId": "IronLoss", "operator": "<=", "value": "1.2" }
    ]
  }
}]

// 高级规则（支持嵌套）
[{
  "resultValue": "不合格",
  "groups": [{
    "mode": "nested",
    "logic": "OR",
    "subGroups": [...]
  }]
}]
```

#### 相关实体

| 实体 | 表名 | 说明 |
|-----|------|------|
| IntermediateDataEntity | LAB_INTERMEDIATE_DATA | 中间数据 |
| IntermediateDataFormulaEntity | LAB_INTERMEDIATE_DATA_FORMULA | 公式配置 |
| IntermediateDataColorEntity | LAB_INTERMEDIATE_DATA_COLOR | 颜色配置 |

---

### 2.3 外观特性模块

#### 核心服务

| 服务 | 文件 | 职责 |
|-----|------|------|
| AppearanceFeatureService | `AppearanceFeatureService.cs` | 特性 CRUD、批量匹配 |
| AppearanceFeatureCategoryService | `AppearanceFeatureCategoryService.cs` | 特性分类管理 |
| AppearanceFeatureLevelService | `AppearanceFeatureLevelService.cs` | 严重等级管理 |
| AppearanceAnalysisService | `AppearanceAnalysisService.cs` | AI 分析服务 |
| AppearanceFeatureRuleMatcher | `AppearanceFeatureRuleMatcher.cs` | 规则匹配引擎 |
| FeatureLearningService | `FeatureLearningService.cs` | 特性学习 |

#### 特性识别流程

```
输入文本（如："轻微划痕"）
  ↓
规则引擎匹配
  ↓ 匹配失败
AI 模型分析
  ↓
返回：特性名称 + 分类 + 严重等级
```

#### 相关实体

| 实体 | 表名 | 说明 |
|-----|------|------|
| AppearanceFeatureEntity | LAB_APPEARANCE_FEATURE | 外观特性定义 |
| AppearanceFeatureCategoryEntity | LAB_APPEARANCE_FEATURE_CATEGORY | 特性分类（树形） |
| AppearanceFeatureLevelEntity | LAB_APPEARANCE_FEATURE_LEVEL | 严重等级 |
| AppearanceFeatureCorrectionEntity | LAB_APPEARANCE_FEATURE_CORRECTION | 人工纠正记录 |

---

### 2.4 产品规格模块

#### 核心服务

| 服务 | 文件 | 职责 |
|-----|------|------|
| ProductSpecService | `ProductSpecService.cs` | 产品规格 CRUD |
| ProductSpecVersionService | `ProductSpecVersionService.cs` | 版本管理 |
| ProductSpecAttributeService | `ProductSpecAttributeService.cs` | 扩展属性管理 |
| ProductSpecPublicAttributeService | `ProductSpecPublicAttributeService.cs` | 公共属性管理 |

#### 版本控制

```
ProductSpec (产品规格)
  └── ProductSpecVersion (版本记录)
        └── ProductSpecAttribute (版本属性)
```

#### 相关实体

| 实体 | 表名 | 说明 |
|-----|------|------|
| ProductSpecEntity | LAB_PRODUCT_SPEC | 产品规格 |
| ProductSpecVersionEntity | LAB_PRODUCT_SPEC_VERSION | 版本记录 |
| ProductSpecAttributeEntity | LAB_PRODUCT_SPEC_ATTRIBUTE | 扩展属性 |
| ProductSpecPublicAttributeEntity | LAB_PRODUCT_SPEC_PUBLIC_ATTRIBUTE | 公共属性 |

---

### 2.5 单位换算模块

#### 核心服务

| 服务 | 文件 | 职责 |
|-----|------|------|
| UnitCategoryService | `UnitCategoryService.cs` | 单位类别管理 |
| UnitDefinitionService | `UnitDefinitionService.cs` | 单位定义管理 |
| UnitConversionService | `UnitConversionService.cs` | 单位换算 |

#### 换算逻辑

```
目标值 = (源值 - 源偏移量) × (目标比例 / 源比例) + 目标偏移量
```

#### 相关实体

| 实体 | 表名 | 说明 |
|-----|------|------|
| UnitCategoryEntity | LAB_UNIT_CATEGORY | 单位类别（长度、重量等） |
| UnitDefinitionEntity | LAB_UNIT_DEFINITION | 单位定义（米、千克等） |

---

### 2.6 公共维度模块

#### 核心服务

| 服务 | 文件 | 职责 |
|-----|------|------|
| PublicDimensionService | `PublicDimensionService.cs` | 公共维度管理（带版本控制） |

#### 相关实体

| 实体 | 表名 | 说明 |
|-----|------|------|
| PublicDimensionEntity | LAB_PUBLIC_DIMENSION | 公共维度 |
| PublicDimensionVersionEntity | LAB_PUBLIC_DIMENSION_VERSION | 版本记录 |

---

### 2.7 磁性数据模块

#### 核心服务

| 服务 | 文件 | 职责 |
|-----|------|------|
| MagneticRawDataService | `MagneticRawDataService.cs` | 磁性数据 CRUD |
| MagneticDataImportSessionService | `MagneticDataImportSessionService.cs` | 导入会话管理（2步） |

#### 相关实体

| 实体 | 表名 | 说明 |
|-----|------|------|
| MagneticRawDataEntity | LAB_MAGNETIC_RAW_DATA | 磁性原始数据 |
| MagneticDataImportSessionEntity | LAB_MAGNETIC_DATA_IMPORT_SESSION | 导入会话 |

---

## 三、API 端点汇总

### 原始数据

| 方法 | 路径 | 说明 |
|-----|------|------|
| POST | `/api/lab/raw-data/import` | 导入原始数据 |
| GET | `/api/lab/raw-data` | 查询原始数据列表 |
| GET | `/api/lab/raw-data/{id}` | 获取单条原始数据 |
| DELETE | `/api/lab/raw-data/{id}` | 删除原始数据 |

### 导入会话

| 方法 | 路径 | 说明 |
|-----|------|------|
| POST | `/api/lab/import-session/start` | 开始导入会话 |
| POST | `/api/lab/import-session/{id}/step2` | 产品规格匹配 |
| POST | `/api/lab/import-session/{id}/step3` | 外观特性匹配 |
| POST | `/api/lab/import-session/{id}/step4` | 确认导入 |
| GET | `/api/lab/import-session/{id}` | 获取会话状态 |

### 中间数据

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/api/lab/intermediate-data` | 查询中间数据列表 |
| GET | `/api/lab/intermediate-data/{id}` | 获取单条中间数据 |
| POST | `/api/lab/intermediate-data/generate` | 生成中间数据 |
| PUT | `/api/lab/intermediate-data/{id}/performance` | 更新性能数据 |
| PUT | `/api/lab/intermediate-data/{id}/appearance` | 更新外观数据 |
| POST | `/api/lab/intermediate-data/calculate-formulas` | 批量计算公式 |

### 公式维护

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/api/lab/intermediate-data-formula` | 获取公式列表 |
| GET | `/api/lab/intermediate-data-formula/{id}` | 获取单个公式 |
| POST | `/api/lab/intermediate-data-formula` | 创建公式 |
| PUT | `/api/lab/intermediate-data-formula/{id}` | 更新公式 |
| DELETE | `/api/lab/intermediate-data-formula/{id}` | 删除公式 |
| POST | `/api/lab/intermediate-data-formula/initialize` | 初始化公式 |
| GET | `/api/lab/intermediate-data-formula/available-columns` | 获取可用列 |

### 外观特性

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/api/lab/appearance-feature` | 获取特性列表 |
| POST | `/api/lab/appearance-feature` | 创建特性 |
| PUT | `/api/lab/appearance-feature/{id}` | 更新特性 |
| DELETE | `/api/lab/appearance-feature/{id}` | 删除特性 |
| POST | `/api/lab/appearance-feature/batch-match` | 批量匹配 |

### 产品规格

| 方法 | 路径 | 说明 |
|-----|------|------|
| GET | `/api/lab/product-spec` | 获取规格列表 |
| GET | `/api/lab/product-spec/{id}` | 获取单个规格 |
| POST | `/api/lab/product-spec` | 创建规格 |
| PUT | `/api/lab/product-spec/{id}` | 更新规格 |
| DELETE | `/api/lab/product-spec/{id}` | 删除规格 |

---

## 四、待完善功能

### 4.1 驾驶舱相关

- [ ] 数据聚合服务（日/班次/规格汇总）
- [ ] 预警规则引擎
- [ ] 不合格原因明细记录

### 4.2 数据质量

- [ ] 判定公式执行时记录每个条件的评估结果
- [ ] 缺陷明细表（支持单卷多缺陷）

### 4.3 性能优化

- [ ] 中间数据查询缓存
- [ ] 公式计算结果缓存
