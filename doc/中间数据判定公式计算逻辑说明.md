# 中间数据判定公式计算逻辑说明

本文档说明中间数据表公式计算在后端的整体流程，重点描述判定（JUDGE）公式的运行逻辑与数据来源。

## 适用范围

- 服务类：`api/src/modularity/lab/Poxiao.Lab/Service/IntermediateDataService.cs`
- 触发场景：原始数据导入后批量生成中间数据、批次计算、手动触发批量计算
- 公式来源：中间数据公式维护表（`LAB_INTERMEDIATE_DATA_FORMULA`）

## 总体流程

1. 从公式维护表一次性读取所有启用公式（`IsEnabled=true` 且 `TableName=INTERMEDIATE_DATA`）。
2. 按公式类型分组：
   - `CALC`：计算公式（需有 `Formula` 内容）
   - `JUDGE`：判定公式（规则 JSON 可为空）
3. 按排序执行：
   - `CALC` 先执行（按 `SortOrder`、`CreatorTime`）。
   - `JUDGE` 再执行（按 `SortOrder`、`CreatorTime`）。
4. 每条中间数据完成计算后更新实体并写回数据库。

## CALC 计算逻辑（简述）

- 上下文数据通过 `ExtractContextDataFromEntity` 生成（提取数值型字段 + Detection/Thickness/LaminationDist 等）。
- 若公式包含 `RANGE()` 或 `DIFF_FIRST_LAST`，使用 `RangeFormulaCalculator` 以实体对象为上下文。
- 普通公式走 `FormulaParser.Calculate(formula, contextData)`。
- 支持默认值与精度处理。

## JUDGE 判定逻辑（核心）

### 1. 判定规则格式

后端支持两类 JSON 结构：

1) **简单判定（JudgmentRuleEditor）**

```
[
  {
    "id": "...",
    "resultValue": "A",
    "rootGroup": {
      "logic": "AND",
      "conditions": [
        { "fieldId": "AvgThickness", "operator": ">=", "value": "0.25" }
      ]
    }
  }
]
```

2) **高级判定（AdvancedJudgmentEditor）**

```
[
  {
    "id": "...",
    "resultValue": "B",
    "groups": [
      {
        "mode": "simple",
        "logic": "OR",
        "conditions": [
          { "leftExpr": "Density", "operator": "<", "rightValue": "7.5" }
        ],
        "subGroups": []
      }
    ]
  }
]
```

### 2. 判定执行顺序

- 按规则数组自上而下执行。
- 只要某条规则命中，立即返回该规则的 `resultValue`，停止后续判断。
- 若无规则命中，则返回 `DefaultValue`（为空则写入空值）。

### 3. 条件求值逻辑

#### 左侧值来源（leftExpr / fieldId）

左侧表达式支持两种模式：

1) **字段名模式**
   - 直接读取 `IntermediateDataEntity` 属性值。
   - 对 `AppearanceFeatureCategoryIds`、`AppearanceFeatureLevelIds` 自动按 JSON 字符串解析为 `List<string>`。

2) **表达式模式**
   - 包含 `[]`、运算符、`RANGE(...)`、`DIFF_FIRST_LAST` 时视为表达式。
   - 通过 `FormulaParser.Calculate` 计算（使用数值上下文）。

#### 操作符支持

- 数值比较：`=`, `<>`, `>`, `>=`, `<`, `<=`
- 空值判断：`IS_NULL`, `NOT_NULL`
- 列表判断：
  - 若左侧为 `List<string>`，`=` 表示包含，`<>` 表示不包含

#### 类型转换策略

- 优先尝试数值比较（decimal）。
- 若无法转换，则按字符串比较（忽略大小写）。
- 右侧值保持为字符串，仅在数值比较时做转换。

### 4. 判定结果写入

命中的 `resultValue` 会写入 `IntermediateDataEntity` 的目标列：

- 目标列名 = `IntermediateDataFormula.ColumnName`
- 支持写入 `string / int / decimal / bool`，类型不兼容时记录日志并跳过。

## 默认值与异常处理

- 规则为空或 JSON 解析失败：
  - 有默认值则使用默认值
  - 无默认值则抛出异常（由上层记录失败状态）
- 单条规则失败：
  - 有默认值则写入默认值
  - 无默认值则抛出异常

## 当前限制

- 右侧值仅支持常量字符串（不支持右侧表达式）。
- 空的条件组默认不命中（不会返回 true）。
- 判定公式不参与 `calcFormulas` 的数值上下文更新。

## 关键实现位置

- 公式读取与批次执行：`BatchCalculateFormulasInternalAsync`
- CALC 计算：`CalculateFormulasForEntityAsync`（CALC 部分）
- JUDGE 解析与执行：
  - `EvaluateJudgeFormula`
  - `EvaluateSimpleRule / EvaluateAdvancedRule`
  - `EvaluateCondition`
  - `SetJudgeValueToEntity`

