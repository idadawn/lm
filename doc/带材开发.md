# 带材检测分析模板开发

## 1. 系统架构与技术栈

* **后端**: .NET 10 (C#)。
* **架构模式**: 领域驱动设计 (DDD)。
* **数据库**: MySQL 5.7+ (支持 JSON 类型)。
* **核心模块**: 单位管理、指标引擎、数据映射器。

---

## 2. 数据库设计 (Database Schema)

### 2.1 公共维度与单位管理 (General Modules)

* **UnitDefinition**: 存储物理单位及其换算系数（如 mm 到 μm 缩放 0.001）。
* **IndicatorDefinition**: 指标定义表。
* `F_CODE`: 指标代码（如 DENSITY）。
* `F_NAME`: 前端显示名。
* `F_EXPRESSION`: 计算公式（如 `(#{W1M}*1000)/(#{WIDTH}*#{AVG_THICK})`）。
* `F_COLUMN_NAME`: 映射到中间表的物理字段名（如 `F_DENSITY`）。
* `F_DECIMAL`: 小数位数。



### 2.2 核心业务表

* **LAB_PRODUCT_SPEC_ATTRIBUTE**: 存储产品规格常量（层数、标样长度、理论密度）。
* `LAYERS`: 默认 20。
* `STD_LENGTH`: 默认 4。
* `THEO_DENSITY`: 默认 7.25。


* **LAB_RAW_DATA**: 存储 Excel 导入的原始值，固定包含 `F_DETECTION_1` 至 `F_DETECTION_22`。

### 2.3 LAB_INTERMEDIATE_DATA (中间表物理化设计)

该表结构严格对应 Excel 导出布局，并采用物理列以支持高性能查询。

| 类别 | 字段名 | 类型 | 精度 | 说明 |
| --- | --- | --- | --- | --- |
| **基础** | `F_PROD_DATE` | DT | - | 检验日期 |
| **磁性能** | `F_PERF_SS_POWER` | DEC | 4 | 初检 Ss (VA/kg) |
|  | `F_PERF_PS_LOSS` | DEC | 4 | 初检 Ps (W/kg) |
|  | `F_PERF_HC` | DEC | 4 | 初检 Hc (A/m) |
|  | `F_AFTER_PS_LOSS` | DEC | 4 | 刻痕后 Ps (W/kg) |
| **物理** | `F_ONE_METER_WT` | DEC | 2 | 一米重 (g) |
|  | `F_STRIP_WIDTH` | DEC | 2 | 带宽 (mm) |
|  | `F_AVG_THICKNESS` | DEC | 2 | 平均厚度 (μm) |
| **成分/花纹** | `F_MID_SI_L/R` | STR | - | 中 Si 左/右 |
|  | `F_L_PATTERN_W/S` | DEC | 2 | 左花纹宽/间距 |
| **原始列** | `F_LAM_DIST_1..22` | DEC | 1 | **叠片总厚度分布** (20层测量值) |
| **人员** | `F_PERF_EDITOR` | STR | - | 性能录入员 |
|  | `F_APPEAR_JUDGE` | STR | - | 外观检验员 |
| **快照** | `F_SNAP_PARAMS` | JSON | - | 记录计算时的层数、密度等快照 |

---

## 3. 后端业务逻辑 (Backend Logic)

### 3.1 动态指标引擎 (Indicator Engine)

实现一个 `FormulaEvaluator` 类，支持变量解析与计算：

1. **变量识别**: 识别公式中的 `#{RAW.xxx}`、`#{SPEC.xxx}`、`#{INTER.xxx}`。
2. **单位规约**: 调用 `UnitConversionService`，确保计算前所有单位统一为基准单位。
3. **计算顺序**: 按照依赖关系计算指标（先算平均厚度，再算密度和叠片系数）。

### 3.2 核心计算公式

* **单层带厚 ()**: ，其中  为叠片分布原始值。
* **平均厚度 ()**: 。
* **密度 ()**: 。
* **叠片系数 ()**: 。
* **带型判定**: 


### 3.3 异常判定逻辑 (Visual Logic)

* **标红判断**: 遍历 1-22 点位，若 ，则将索引  存入 `F_THICKNESS_ABNORMAL` JSON 数组。

---

## 4. 前端设计规范 (Frontend Design)

### 4.1 动态表格组件

* **元数据驱动**: 表格列头由 `IndicatorDefinition` 动态生成。
* **虚拟列渲染**: 数据库不存 `F_THICK_1..22`，前端通过 `F_LAM_DIST_i / LAYERS` 实时计算展示。
* **标红实现**: 检查单元格索引是否在 `F_THICKNESS_ABNORMAL` 中，匹配则添加 `text-danger` 样式。

### 4.2 交互设计

* **图表联动**: 点击任意一行，下方 ECharts 自动绘制横向厚度分布曲线。
* **指标编辑器**: 提供 UI 供用户修改 `F_EXPRESSION`，支持从左侧列表拖拽字段进入公式框。

---

## 5. 导入与导出 (Data Exchange)

### 5.1 导入向导

* 支持 Excel 1-22 列原始检测数据的批量映射。
* **自动解析**: 炉号后缀（如“脆”）自动存入 `F_APPEAR_FEATURE` 并匹配 `F_FEATURE_IDS`。

### 5.2 导出逻辑

* 导出表头使用指标定义的 `F_NAME`。
* **动态列过滤**: 根据产品规格定义的有效点位（如 15 个），自动隐藏导出 Excel 中的第 16-22 列。

---

## 6. 开发任务清单 (Cursor Prompt 指令)

> **任务 1**: 创建通用 `UnitDefinition` 实体及换算服务，支持跨维度单位校验。
> **任务 2**: 实现 `IntermediateData` 物理表实体，包含 22 个 `F_LAM_DIST` 字段及磁性能 6 列。
> **任务 3**: 编写 `IndicatorEngine`，支持从 `PRODUCT_SPEC_ATTRIBUTE` 抓取 `LAYERS` 等常量进行公式解析。
> **任务 4**: 前端开发基于元数据的 Grid 组件，实现相邻点位差值 > 1.5μm 的实时渲染。
