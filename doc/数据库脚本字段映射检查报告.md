# 数据库脚本字段映射检查报告

## 检查日期
2025-01-19

## 检查范围
检查所有数据库脚本与 `CLDEntityBase` 实体基类字段映射的一致性。

## CLDEntityBase 基类字段规范

### 基类字段名（注意大小写规则）

1. **创建相关字段（全大写，无下划线）：**
   - `F_CREATORTIME` - 创建时间
   - `F_CREATORUSERID` - 创建用户ID
   - `F_ENABLEDMARK` - 启用标识

2. **修改和删除相关字段（F_ 后首字母大写）：**
   - `F_LastModifyTime` - 修改时间
   - `F_LastModifyUserId` - 修改用户ID
   - `F_DeleteMark` - 删除标志
   - `F_DeleteTime` - 删除时间
   - `F_DeleteUserId` - 删除用户ID

## 发现的问题

### 1. ✅ 已修复：MagneticDataImportSessionEntity 缺少 LastModifyUserId 字段映射

**问题描述：**
- 数据库脚本 `migration_create_magnetic_data_import_session_table.sql` 中定义了 `F_LAST_MODIFY_USER_ID` 字段
- 但实体类 `MagneticDataImportSessionEntity` 中缺少该字段的重写映射
- 导致会使用基类的 `F_LastModifyUserId`（大小写不匹配），可能引发字段映射错误

**修复方案：**
已在 `MagneticDataImportSessionEntity.cs` 中添加 `LastModifyUserId` 字段的重写映射。

### 2. ✅ 已修复：RawDataImportSessionEntity 缺少 LastModifyUserId 字段映射

**问题描述：**
- 数据库脚本 `fix_lab_raw_data_import_session_table.sql` 中定义了 `F_LAST_MODIFY_USER_ID` 字段
- 但实体类 `RawDataImportSessionEntity` 中缺少该字段的重写映射

**修复方案：**
已在 `RawDataImportSessionEntity.cs` 中添加 `LastModifyUserId` 字段的重写映射。

### 3. ⚠️ 字段命名不一致问题

**问题描述：**
部分数据库表使用了与基类不同的字段命名规范：

#### 使用带下划线的字段名（与基类不一致）：
- `lab_magnetic_data_import_session` 表：
  - `F_CREATOR_TIME` (基类: `F_CREATORTIME`)
  - `F_CREATOR_USER_ID` (基类: `F_CREATORUSERID`)
  - `F_LAST_MODIFY_TIME` (基类: `F_LastModifyTime`)
  - `F_LAST_MODIFY_USER_ID` (基类: `F_LastModifyUserId`)

- `lab_raw_data_import_session` 表：
  - `F_CREATOR_TIME` (基类: `F_CREATORTIME`)
  - `F_CREATOR_USER_ID` (基类: `F_CREATORUSERID`)
  - `F_LAST_MODIFY_TIME` (基类: `F_LastModifyTime`)
  - `F_LAST_MODIFY_USER_ID` (基类: `F_LastModifyUserId`)

#### 使用基类标准字段名（一致）：
- `LAB_MAGNETIC_RAW_DATA` 表：✅ 使用基类标准字段名
- `LAB_EXCEL_IMPORT_TEMPLATE` 表：✅ 使用基类标准字段名
- `LAB_RAW_DATA` 表：✅ 使用基类标准字段名

**处理方式：**
对于字段名不一致的表，实体类已通过重写属性并指定 `ColumnName` 来正确映射，这是正确的处理方式。

## 检查结果汇总

### ✅ 正确的表（使用基类标准字段名）
1. `LAB_MAGNETIC_RAW_DATA` - 磁性原始数据表
2. `LAB_EXCEL_IMPORT_TEMPLATE` - Excel导入模板表
3. `LAB_RAW_DATA` - 原始数据表

### ⚠️ 需要字段映射重写的表（使用带下划线字段名）
1. `lab_magnetic_data_import_session` - 磁性数据导入会话表
   - ✅ 已修复：实体类已正确重写所有字段映射
   
2. `lab_raw_data_import_session` - 原始数据导入会话表
   - ✅ 已修复：实体类已正确重写所有字段映射

## 建议

### 1. 统一字段命名规范
建议在创建新表时，统一使用 `CLDEntityBase` 基类的标准字段名：
- `F_CREATORTIME`（不是 `F_CREATOR_TIME`）
- `F_CREATORUSERID`（不是 `F_CREATOR_USER_ID`）
- `F_LastModifyTime`（不是 `F_LAST_MODIFY_TIME`）
- `F_LastModifyUserId`（不是 `F_LAST_MODIFY_USER_ID`）

这样可以避免在实体类中需要重写字段映射。

### 2. 检查清单
在创建或修改继承 `CLDEntityBase` 的实体类时，请检查：
- [x] 数据库表字段名是否与基类字段名完全匹配（注意大小写和下划线）
- [x] 如果表字段名不同，是否已重写属性并指定正确的 `ColumnName`
- [x] 如果表中不存在某些基类字段，是否已使用 `IsIgnore = true` 忽略映射
- [x] 所有字段映射是否正确，避免运行时出现 "Unknown column" 错误

### 3. 文档更新
已更新 `.cursorrules` 文件，添加了实体基类字段映射的注意事项和示例。

## 修复文件清单

1. ✅ `api/src/modularity/lab/Poxiao.Lab.Entity/Entity/MagneticDataImportSessionEntity.cs`
   - 添加了 `LastModifyUserId` 字段的重写映射

2. ✅ `api/src/modularity/lab/Poxiao.Lab.Entity/Entity/RawDataImportSessionEntity.cs`
   - 添加了 `LastModifyUserId` 字段的重写映射

## 验证建议

建议在部署前验证：
1. 所有实体类的字段映射是否与数据库表结构一致
2. 运行单元测试，确保没有字段映射错误
3. 检查日志，确认没有 "Unknown column" 错误
