version: '3.8'

services:
  # 1. MySQL 数据库 - 主数据库
  mysql:
    image: mysql:${MYSQL_VERSION}
    container_name: ${CONTAINER_PREFIX}-mysql
    restart: always
    ports:
      - "${MYSQL_PORT}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: ${MYSQL_TIMEZONE}
    command:
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --default-authentication-plugin=mysql_native_password
      --max_connections=1000
    volumes:
      - ${DEPLOY_DIR}/mysql_data:/var/lib/mysql
      - ${DEPLOY_DIR}/mysql_init:/docker-entrypoint-initdb.d
    networks:
      - ${NETWORK_NAME}

  # 2. Redis 缓存 - 缓存和会话存储
  redis:
    image: redis:${REDIS_VERSION}
    container_name: ${CONTAINER_PREFIX}-redis
    restart: always
    ports:
      - "${REDIS_PORT}:6379"
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
    volumes:
      - ${DEPLOY_DIR}/redis_data:/data
    networks:
      - ${NETWORK_NAME}

  # 3. 向量数据库 (Qdrant) - 存储外观特性定义与指标定义
  qdrant:
    image: qdrant/qdrant:${QDRANT_VERSION}
    container_name: ${CONTAINER_PREFIX}-qdrant
    restart: always
    ports:
      - "${QDRANT_HTTP_PORT}:6333"
      - "${QDRANT_GRPC_PORT}:6334"
    volumes:
      - ${DEPLOY_DIR}/qdrant_storage:/qdrant/storage
    networks:
      - ${NETWORK_NAME}

  # 4. 向量推理引擎 (TEI) - 用于外观特性语义匹配 (SRS 4.1)
  tei-embedding:
    image: ghcr.io/huggingface/text-embeddings-inference:${TEI_VERSION}
    container_name: ${CONTAINER_PREFIX}-tei
    runtime: nvidia
    restart: always
    ports:
      - "${TEI_PORT}:80"
    environment:
      - HF_HUB_OFFLINE=1  # 开启离线模式
      - HUGGINGFACE_HUB_CACHE=/data
    volumes:
      # 挂载公共位置的 BGE-M3 模型
      - ${TEI_MODEL_PATH}:/data/model
    # 强制从本地路径加载模型
    command: --model-id /data/model --max-client-batch-size ${TEI_MAX_BATCH_SIZE}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - ${NETWORK_NAME}

  # 5. 大模型推理引擎 (vLLM) - 用于自然语言问数 (SRS 4.5)
  vllm:
    image: vllm/vllm-openai:${VLLM_VERSION}
    container_name: ${CONTAINER_PREFIX}-vllm
    runtime: nvidia
    restart: always
    ports:
      - "${VLLM_PORT}:8082"
    environment:
      - HF_HUB_OFFLINE=1  # 开启离线模式
    volumes:
      # 挂载公共位置的 Qwen2.5-7B 模型
      - ${VLLM_MODEL_PATH}:/data/qwen2.5-7b
    # 命令说明：
    # --model: 指向容器内的模型路径
    # --gpu-memory-utilization: 建议设为 0.7，留出显存给 TEI 引擎
    command: >
      --model /data/qwen2.5-7b
      --host 0.0.0.0
      --port 8082
      --trust-remote-code
      --gpu-memory-utilization ${VLLM_GPU_MEMORY_UTILIZATION}
      --max-model-len ${VLLM_MAX_MODEL_LEN}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - ${NETWORK_NAME}

networks:
  ${NETWORK_NAME}:
    driver: bridge
