# è‡ªåŠ¨æ„å»ºä½¿ç”¨æŒ‡å—

## ğŸ¯ é€šè¿‡ .env æ–‡ä»¶æ§åˆ¶è‡ªåŠ¨æ„å»º

æ¯å°æœºå™¨å¯ä»¥é€šè¿‡ `.env` æ–‡ä»¶ç‹¬ç«‹é…ç½®æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ„å»ºã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1ï¼šå¯ç”¨è‡ªåŠ¨æ„å»º

ç¼–è¾‘é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ï¼š

```bash
# å¯ç”¨è‡ªåŠ¨æ„å»º
AUTO_BUILD=true
```

### æ­¥éª¤ 2ï¼šæäº¤ä»£ç 

```bash
# 1. ä¿®æ”¹ä»£ç 
vim api/...

# 2. å¢åŠ ç‰ˆæœ¬å·
./scripts/version.sh bump patch

# 3. æäº¤ä»£ç ï¼ˆä¼šè‡ªåŠ¨è§¦å‘æ„å»ºï¼‰
git add .
git commit -m "feat: æ–°åŠŸèƒ½"
```

### æ­¥éª¤ 3ï¼šæŸ¥çœ‹æ„å»ºæ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ„å»ºæ—¥å¿—
tail -f .build.log
```

### æ­¥éª¤ 4ï¼šå¯åŠ¨æœåŠ¡

```bash
# æ„å»ºæˆåŠŸåå¯åŠ¨æœåŠ¡
docker-compose up -d
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### .env æ–‡ä»¶é…ç½®

```bash
# ============================================
# è‡ªåŠ¨æ„å»ºé…ç½®
# ============================================
# æ˜¯å¦åœ¨æäº¤ä»£ç æ—¶è‡ªåŠ¨æ„å»º Docker é•œåƒ
# è®¾ç½®ä¸º true æ—¶ï¼Œæ¯æ¬¡æäº¤ä»£ç ï¼ˆå¦‚æœ VERSION æ–‡ä»¶å˜æ›´ï¼‰ä¼šè‡ªåŠ¨è§¦å‘æ„å»º
# é»˜è®¤ä¸º falseï¼Œæ¯å°æœºå™¨å¯ç‹¬ç«‹é…ç½®
AUTO_BUILD=false
```

### é…ç½®é€‰é¡¹

| é€‰é¡¹ | è¯´æ˜ | æ¨èåœºæ™¯ |
|------|------|----------|
| `AUTO_BUILD=true` | å¯ç”¨è‡ªåŠ¨æ„å»º | å¼€å‘æœºã€æ„å»ºæœåŠ¡å™¨ |
| `AUTO_BUILD=false` | ç¦ç”¨è‡ªåŠ¨æ„å»º | ç”Ÿäº§æœºã€å…¶ä»–å¼€å‘æœº |

---

## ğŸ“‹ å·¥ä½œæµç¨‹

### å¼€å‘æœºå™¨ï¼ˆå¯ç”¨è‡ªåŠ¨æ„å»ºï¼‰

```bash
# 1. åœ¨ .env ä¸­å¯ç”¨
echo "AUTO_BUILD=true" >> .env

# 2. ä¿®æ”¹ä»£ç 
vim api/...

# 3. æ›´æ–°ç‰ˆæœ¬
./scripts/version.sh bump patch

# 4. æäº¤ï¼ˆè‡ªåŠ¨è§¦å‘æ„å»ºï¼‰
git add .
git commit -m "feat: æ–°åŠŸèƒ½"

# 5. ç­‰å¾…æ„å»ºå®Œæˆ
tail -f .build.log

# 6. å¯åŠ¨æœåŠ¡
docker-compose up -d
```

### å…¶ä»–æœºå™¨ï¼ˆç¦ç”¨è‡ªåŠ¨æ„å»ºï¼‰

```bash
# .env ä¸­ AUTO_BUILD=false

# æäº¤ä»£ç ä¸ä¼šè§¦å‘æ„å»º
git add .
git commit -m "feat: æ–°åŠŸèƒ½"

# å¦‚éœ€æ„å»ºï¼Œæ‰‹åŠ¨æ‰§è¡Œ
./scripts/build.sh
```

---

## ğŸ”§ æ„å»ºæ—¥å¿—

### æ—¥å¿—ä½ç½®

- æ„å»ºæ—¥å¿—ï¼š`.build.log`ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
- å®æ—¶æŸ¥çœ‹ï¼š`tail -f .build.log`

### æ—¥å¿—æ ¼å¼

```
[2025-01-22 13:45:30] å¼€å§‹æ„å»º Docker é•œåƒ...
ç‰ˆæœ¬: 1.0.1
[2025-01-22 13:48:15] âœ… æ„å»ºæˆåŠŸï¼
é•œåƒæ ‡ç­¾: lm-api:1.0.1, lm-web:1.0.1

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœåŠ¡:
  docker-compose up -d
```

---

## ğŸŒ å¤šæœºå™¨åä½œåœºæ™¯

### åœºæ™¯ 1ï¼šä¸“ç”¨æ„å»ºæœåŠ¡å™¨

```bash
# æ„å»ºæœåŠ¡å™¨
cd /path/to/project
echo "AUTO_BUILD=true" >> .env

# æ¯æ¬¡æ¨é€ä»£ç åï¼Œæ„å»ºæœåŠ¡å™¨æ‹‰å–å¹¶æ„å»º
git pull
# å¦‚æœ VERSION å˜æ›´ï¼Œè‡ªåŠ¨æ„å»º
```

### åœºæ™¯ 2ï¼šå¼€å‘æœºå™¨

```bash
# å¼€å‘è€… A çš„æœºå™¨ï¼ˆå¯ç”¨è‡ªåŠ¨æ„å»ºï¼‰
echo "AUTO_BUILD=true" >> .env

# å¼€å‘è€… B çš„æœºå™¨ï¼ˆç¦ç”¨è‡ªåŠ¨æ„å»ºï¼‰
echo "AUTO_BUILD=false" >> .env
```

### åœºæ™¯ 3ï¼šç”Ÿäº§ç¯å¢ƒ

```bash
# ç”Ÿäº§æœåŠ¡å™¨ï¼ˆç¦ç”¨è‡ªåŠ¨æ„å»ºï¼‰
echo "AUTO_BUILD=false" >> .env

# ç”Ÿäº§ç¯å¢ƒåªæ‹‰å–é•œåƒï¼Œä¸æ„å»º
docker pull your-registry/lm-api:1.0.1
docker pull your-registry/lm-web:1.0.1
docker-compose up -d
```

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### è‡ªåŠ¨æ„å»ºä¸è§¦å‘

```bash
# 1. æ£€æŸ¥ .env é…ç½®
grep AUTO_BUILD .env

# 2. æ£€æŸ¥ VERSION æ–‡ä»¶æ˜¯å¦å˜æ›´
git diff HEAD~1 HEAD -- VERSION

# 3. æ£€æŸ¥ hook æ–‡ä»¶æƒé™
ls -la .git/hooks/post-commit

# 4. æ‰‹åŠ¨æµ‹è¯• hook
.git/hooks/post-commit
```

### æ„å»ºå¤±è´¥

```bash
# æŸ¥çœ‹å®Œæ•´æ„å»ºæ—¥å¿—
cat .build.log

# æ‰‹åŠ¨æ„å»º
./scripts/build.sh
```

---

## ğŸ“š æœ€ä½³å®è·µ

1. **å¼€å‘æœºå™¨**ï¼šè®¾ç½® `AUTO_BUILD=true`ï¼Œæ–¹ä¾¿æœ¬åœ°æµ‹è¯•
2. **ç”Ÿäº§æœåŠ¡å™¨**ï¼šè®¾ç½® `AUTO_BUILD=false`ï¼Œä½¿ç”¨é¢„æ„å»ºé•œåƒ
3. **CI/CD**ï¼šä½¿ç”¨ GitHub Actions è‡ªåŠ¨æ„å»ºå¹¶æ¨é€åˆ°é•œåƒä»“åº“
4. **ç‰ˆæœ¬ç®¡ç†**ï¼šæ¯æ¬¡æäº¤éƒ½æ›´æ–°ç‰ˆæœ¬å·
5. **æ—¥å¿—ç®¡ç†**ï¼šå®šæœŸæ¸…ç† `.build.log`

---

## ğŸ”„ ä¸ GitHub Actions é…åˆ

### æœ¬åœ°å¼€å‘ï¼ˆä½¿ç”¨è‡ªåŠ¨æ„å»ºï¼‰

```bash
# .env: AUTO_BUILD=true
./scripts/version.sh bump patch
git commit -m "feat: æ–°åŠŸèƒ½"
# æœ¬åœ°è‡ªåŠ¨æ„å»º...
```

### ç”Ÿäº§å‘å¸ƒï¼ˆä½¿ç”¨ GitHub Actionsï¼‰

```bash
# .env: AUTO_BUILD=false

# 1. åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
./scripts/version.sh set 1.0.0
git commit -m "release: v1.0.0"
git tag -a v1.0.0 -m "Release 1.0.0"
git push --tags

# 2. GitHub Actions è‡ªåŠ¨æ„å»º
# 3. ç”Ÿäº§æœåŠ¡å™¨æ‹‰å–é•œåƒ
docker pull your-registry/lm-api:1.0.0
docker-compose up -d
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- éƒ¨ç½²æŒ‡å—ï¼š`scripts/README-DEPLOY.md`
- ç‰ˆæœ¬ç®¡ç†ï¼š`./scripts/version.sh help`
- GitHub Actionsï¼š`.github/workflows/docker-build.yml`
