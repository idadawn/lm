# äº§å“å®šä¹‰æ‰©å±•ä¿¡æ¯ç‰ˆæœ¬ç®¡ç†æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚èƒŒæ™¯

### é—®é¢˜æè¿°
- äº§å“å®šä¹‰çš„æ‰©å±•ä¿¡æ¯ï¼ˆé•¿åº¦ã€å±‚æ•°ã€å¯†åº¦ç­‰ï¼‰ç”¨äºåç»­è®¡ç®—
- äº§å“ä¼šè¿›è¡Œè¿­ä»£ï¼Œæ‰©å±•ä¿¡æ¯å¯èƒ½ä¼šè°ƒæ•´
- **æ ¸å¿ƒéœ€æ±‚**ï¼š
  1. æ‰©å±•ä¿¡æ¯å˜æ›´ä¸å½±å“ä¹‹å‰çš„æ•°æ®è®¡ç®—ï¼ˆå†å²æ•°æ®ä½¿ç”¨å†å²ç‰ˆæœ¬ï¼‰
  2. å½“å‰è®¡ç®—ä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬æ•°æ®ï¼ˆæ–°æ•°æ®ä½¿ç”¨æ–°ç‰ˆæœ¬ï¼‰

### ä¸šåŠ¡åœºæ™¯
- **åœºæ™¯1**ï¼šäº§å“è§„æ ¼Açš„å¯†åº¦ä»7.25è°ƒæ•´ä¸º7.30
  - å†å²æ•°æ®ï¼ˆå·²ç”Ÿæˆçš„ä¸­é—´æ•°æ®ï¼‰åº”ç»§ç»­ä½¿ç”¨7.25è¿›è¡Œè®¡ç®—
  - æ–°å¯¼å…¥çš„æ•°æ®åº”ä½¿ç”¨7.30è¿›è¡Œè®¡ç®—

- **åœºæ™¯2**ï¼šäº§å“è§„æ ¼Bæ–°å¢äº†æ‰©å±•å±æ€§"åšåº¦"
  - å†å²æ•°æ®ä¸å—å½±å“ï¼ˆå†å²æ•°æ®ç”Ÿæˆæ—¶æ²¡æœ‰åšåº¦å±æ€§ï¼‰
  - æ–°æ•°æ®å¯ä»¥ä½¿ç”¨åšåº¦å±æ€§è¿›è¡Œè®¡ç®—

---

## ğŸ¯ è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è¿°
é‡‡ç”¨**ç‰ˆæœ¬å¿«ç…§ (Version Snapshot)** çš„æ–¹å¼ï¼š
1. æ¯æ¬¡ä¿®æ”¹æ‰©å±•ä¿¡æ¯æ—¶ï¼Œåˆ›å»ºæ–°ç‰ˆæœ¬ï¼ˆä¿ç•™å†å²ç‰ˆæœ¬ï¼‰
2. ç”Ÿæˆä¸­é—´æ•°æ®æ—¶ï¼Œè®°å½•ä½¿ç”¨çš„ç‰ˆæœ¬å·
3. è®¡ç®—æ—¶ï¼Œæ ¹æ®ç‰ˆæœ¬å·è·å–å¯¹åº”çš„æ‰©å±•ä¿¡æ¯å¿«ç…§

### æ ¸å¿ƒè®¾è®¡åŸåˆ™
- âœ… **å†å²æ•°æ®ä¸å˜**ï¼šå·²ç”Ÿæˆçš„ä¸­é—´æ•°æ®ä½¿ç”¨ç”Ÿæˆæ—¶çš„ç‰ˆæœ¬ï¼Œä¸å—åç»­ä¿®æ”¹å½±å“
- âœ… **æ–°æ•°æ®ç”¨æ–°ç‰ˆæœ¬**ï¼šæ–°ç”Ÿæˆçš„ä¸­é—´æ•°æ®è‡ªåŠ¨ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
- âœ… **å‘åå…¼å®¹**ï¼šæ²¡æœ‰ç‰ˆæœ¬å·çš„æ—§æ•°æ®é»˜è®¤ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
- âœ… **ç‰ˆæœ¬å¯è¿½æº¯**ï¼šå¯ä»¥æŸ¥çœ‹å†å²ç‰ˆæœ¬å’Œå˜æ›´è®°å½•

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### 1. äº§å“è§„æ ¼æ‰©å±•å±æ€§è¡¨ï¼ˆLAB_PRODUCT_SPEC_ATTRIBUTEï¼‰

**æ–°å¢å­—æ®µ**ï¼š
```sql
-- ç‰ˆæœ¬å·ï¼ˆæ•´æ•°ï¼Œä»1å¼€å§‹é€’å¢ï¼‰
ALTER TABLE LAB_PRODUCT_SPEC_ATTRIBUTE 
ADD COLUMN F_VERSION INT DEFAULT 1;

-- ç‰ˆæœ¬åˆ›å»ºæ—¶é—´
ALTER TABLE LAB_PRODUCT_SPEC_ATTRIBUTE 
ADD COLUMN F_VERSION_CREATE_TIME DATETIME;

-- ç‰ˆæœ¬è¯´æ˜ï¼ˆå¯é€‰ï¼Œè®°å½•ç‰ˆæœ¬å˜æ›´åŸå› ï¼‰
ALTER TABLE LAB_PRODUCT_SPEC_ATTRIBUTE 
ADD COLUMN F_VERSION_DESCRIPTION VARCHAR(500);
```

**å­—æ®µè¯´æ˜**ï¼š
- `F_VERSION`ï¼šç‰ˆæœ¬å·ï¼ŒåŒä¸€äº§å“è§„æ ¼çš„åŒä¸€å±æ€§é”®å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬
- `F_VERSION_CREATE_TIME`ï¼šç‰ˆæœ¬åˆ›å»ºæ—¶é—´ï¼Œç”¨äºæ’åºå’Œè¿½æº¯
- `F_VERSION_DESCRIPTION`ï¼šç‰ˆæœ¬è¯´æ˜ï¼Œè®°å½•å˜æ›´åŸå› ï¼ˆå¦‚"å¯†åº¦è°ƒæ•´ï¼š7.25 â†’ 7.30"ï¼‰

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•ï¼šäº§å“è§„æ ¼ID + å±æ€§é”® + ç‰ˆæœ¬å·ï¼ˆç”¨äºå¿«é€ŸæŸ¥è¯¢ç‰¹å®šç‰ˆæœ¬ï¼‰
CREATE INDEX idx_product_spec_attribute_version 
ON LAB_PRODUCT_SPEC_ATTRIBUTE(F_PRODUCT_SPEC_ID, F_ATTRIBUTE_KEY, F_VERSION);

-- ç´¢å¼•ï¼šäº§å“è§„æ ¼ID + ç‰ˆæœ¬å·ï¼ˆç”¨äºæŸ¥è¯¢æŸä¸ªç‰ˆæœ¬çš„æ‰€æœ‰å±æ€§ï¼‰
CREATE INDEX idx_product_spec_version 
ON LAB_PRODUCT_SPEC_ATTRIBUTE(F_PRODUCT_SPEC_ID, F_VERSION);
```

### 2. äº§å“è§„æ ¼ç‰ˆæœ¬å¿«ç…§è¡¨ï¼ˆLAB_PRODUCT_SPEC_VERSIONï¼‰

**è¡¨ç»“æ„**ï¼š
```sql
CREATE TABLE LAB_PRODUCT_SPEC_VERSION (
    F_ID VARCHAR(50) PRIMARY KEY,
    F_PRODUCT_SPEC_ID VARCHAR(50) NOT NULL,
    F_VERSION INT NOT NULL,
    F_VERSION_NAME VARCHAR(100),  -- ç‰ˆæœ¬åç§°ï¼ˆå¦‚ï¼šv1.0, v2.0ï¼‰
    F_VERSION_DESCRIPTION VARCHAR(500),  -- ç‰ˆæœ¬è¯´æ˜
    F_IS_CURRENT INT DEFAULT 0,  -- æ˜¯å¦ä¸ºå½“å‰ç‰ˆæœ¬ï¼ˆ1=æ˜¯ï¼Œ0=å¦ï¼‰
    F_CREATOR_USER_ID VARCHAR(50),
    F_CREATOR_TIME DATETIME,
    F_LAST_MODIFY_TIME DATETIME,
    F_DELETE_MARK DATETIME,
    F_TENANT_ID VARCHAR(50)
);

-- ç´¢å¼•
CREATE INDEX idx_product_spec_version_spec ON LAB_PRODUCT_SPEC_VERSION(F_PRODUCT_SPEC_ID, F_VERSION);
CREATE INDEX idx_product_spec_version_current ON LAB_PRODUCT_SPEC_VERSION(F_PRODUCT_SPEC_ID, F_IS_CURRENT);
```

**è®¾è®¡è¯´æ˜**ï¼š
- æ¯ä¸ªç‰ˆæœ¬å¯¹åº”ä¸€ä¸ªå¿«ç…§è®°å½•
- `F_IS_CURRENT` æ ‡è®°å½“å‰ä½¿ç”¨çš„ç‰ˆæœ¬
- ç‰ˆæœ¬å·ä»1å¼€å§‹é€’å¢
- æ¯æ¬¡ä¿®æ”¹æ‰©å±•ä¿¡æ¯æ—¶ï¼Œåˆ›å»ºæ–°ç‰ˆæœ¬å¹¶æ ‡è®°ä¸ºå½“å‰ç‰ˆæœ¬

### 3. ä¸­é—´æ•°æ®è¡¨ï¼ˆLAB_INTERMEDIATE_DATAï¼‰

**æ–°å¢å­—æ®µ**ï¼š
```sql
-- äº§å“è§„æ ¼ç‰ˆæœ¬å·ï¼ˆè®°å½•ç”Ÿæˆä¸­é—´æ•°æ®æ—¶ä½¿ç”¨çš„ç‰ˆæœ¬ï¼‰
ALTER TABLE LAB_INTERMEDIATE_DATA 
ADD COLUMN F_PRODUCT_SPEC_VERSION INT;

-- ç´¢å¼•
CREATE INDEX idx_intermediate_data_spec_version 
ON LAB_INTERMEDIATE_DATA(F_PRODUCT_SPEC_ID, F_PRODUCT_SPEC_VERSION);
```

**å­—æ®µè¯´æ˜**ï¼š
- `F_PRODUCT_SPEC_VERSION`ï¼šè®°å½•ç”Ÿæˆä¸­é—´æ•°æ®æ—¶ä½¿ç”¨çš„äº§å“è§„æ ¼ç‰ˆæœ¬å·
- å¦‚æœä¸ºNULLï¼Œè¡¨ç¤ºä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼ˆå‘åå…¼å®¹æ—§æ•°æ®ï¼‰

---

## ğŸ”§ å®ä½“ç±»è®¾è®¡

### 1. ProductSpecAttributeEntityï¼ˆæ‰©å±•å±æ€§å®ä½“ï¼‰

```csharp
/// <summary>
/// äº§å“è§„æ ¼æ‰©å±•å±æ€§.
/// </summary>
[SugarTable("LAB_PRODUCT_SPEC_ATTRIBUTE")]
[Tenant(ClaimConst.TENANTID)]
public class ProductSpecAttributeEntity : CLDEntityBase
{
    // ... ç°æœ‰å­—æ®µ ...
    
    /// <summary>
    /// ç‰ˆæœ¬å·ï¼ˆä»1å¼€å§‹é€’å¢ï¼‰.
    /// </summary>
    [SugarColumn(ColumnName = "F_VERSION", IsNullable = false)]
    public int Version { get; set; } = 1;

    /// <summary>
    /// ç‰ˆæœ¬åˆ›å»ºæ—¶é—´.
    /// </summary>
    [SugarColumn(ColumnName = "F_VERSION_CREATE_TIME", IsNullable = true)]
    public DateTime? VersionCreateTime { get; set; }

    /// <summary>
    /// ç‰ˆæœ¬è¯´æ˜ï¼ˆè®°å½•å˜æ›´åŸå› ï¼‰.
    /// </summary>
    [SugarColumn(ColumnName = "F_VERSION_DESCRIPTION", Length = 500, IsNullable = true)]
    public string VersionDescription { get; set; }
}
```

### 2. ProductSpecVersionEntityï¼ˆç‰ˆæœ¬å¿«ç…§å®ä½“ï¼‰

```csharp
/// <summary>
/// äº§å“è§„æ ¼ç‰ˆæœ¬å¿«ç…§.
/// </summary>
[SugarTable("LAB_PRODUCT_SPEC_VERSION")]
[Tenant(ClaimConst.TENANTID)]
public class ProductSpecVersionEntity : CLDEntityBase
{
    /// <summary>
    /// äº§å“è§„æ ¼ID.
    /// </summary>
    [SugarColumn(ColumnName = "F_PRODUCT_SPEC_ID", IsNullable = false, Length = 50)]
    public string ProductSpecId { get; set; }

    /// <summary>
    /// ç‰ˆæœ¬å·ï¼ˆä»1å¼€å§‹é€’å¢ï¼‰.
    /// </summary>
    [SugarColumn(ColumnName = "F_VERSION", IsNullable = false)]
    public int Version { get; set; }

    /// <summary>
    /// ç‰ˆæœ¬åç§°ï¼ˆå¦‚ï¼šv1.0, v2.0ï¼‰.
    /// </summary>
    [SugarColumn(ColumnName = "F_VERSION_NAME", Length = 100, IsNullable = true)]
    public string VersionName { get; set; }

    /// <summary>
    /// ç‰ˆæœ¬è¯´æ˜ï¼ˆè®°å½•å˜æ›´åŸå› ï¼‰.
    /// </summary>
    [SugarColumn(ColumnName = "F_VERSION_DESCRIPTION", Length = 500, IsNullable = true)]
    public string VersionDescription { get; set; }

    /// <summary>
    /// æ˜¯å¦ä¸ºå½“å‰ç‰ˆæœ¬ï¼ˆ1=æ˜¯ï¼Œ0=å¦ï¼‰.
    /// </summary>
    [SugarColumn(ColumnName = "F_IS_CURRENT", IsNullable = false)]
    public int IsCurrent { get; set; } = 0;
}
```

### 3. IntermediateDataEntityï¼ˆä¸­é—´æ•°æ®å®ä½“ï¼‰

```csharp
/// <summary>
/// ä¸­é—´æ•°æ®è¡¨.
/// </summary>
[SugarTable("LAB_INTERMEDIATE_DATA")]
[Tenant(ClaimConst.TENANTID)]
public class IntermediateDataEntity : CLDEntityBase
{
    // ... ç°æœ‰å­—æ®µ ...
    
    /// <summary>
    /// äº§å“è§„æ ¼ç‰ˆæœ¬å·ï¼ˆè®°å½•ç”Ÿæˆä¸­é—´æ•°æ®æ—¶ä½¿ç”¨çš„ç‰ˆæœ¬ï¼‰.
    /// </summary>
    [SugarColumn(ColumnName = "F_PRODUCT_SPEC_VERSION", IsNullable = true)]
    public int? ProductSpecVersion { get; set; }
}
```

---

## ğŸ’» ä¸šåŠ¡é€»è¾‘å®ç°

### 1. ç‰ˆæœ¬ç®¡ç†æœåŠ¡ï¼ˆProductSpecVersionServiceï¼‰

```csharp
/// <summary>
/// äº§å“è§„æ ¼ç‰ˆæœ¬ç®¡ç†æœåŠ¡.
/// </summary>
public class ProductSpecVersionService
{
    private readonly ISqlSugarRepository<ProductSpecVersionEntity> _versionRepository;
    private readonly ISqlSugarRepository<ProductSpecAttributeEntity> _attributeRepository;

    /// <summary>
    /// è·å–äº§å“è§„æ ¼çš„å½“å‰ç‰ˆæœ¬å·.
    /// </summary>
    public async Task<int> GetCurrentVersionAsync(string productSpecId)
    {
        var currentVersion = await _versionRepository
            .AsQueryable()
            .Where(v => v.ProductSpecId == productSpecId 
                && v.IsCurrent == 1 
                && v.DeleteMark == null)
            .FirstAsync();

        return currentVersion?.Version ?? 1; // å¦‚æœæ²¡æœ‰ç‰ˆæœ¬è®°å½•ï¼Œè¿”å›1ï¼ˆé»˜è®¤ç‰ˆæœ¬ï¼‰
    }

    /// <summary>
    /// åˆ›å»ºæ–°ç‰ˆæœ¬ï¼ˆå½“æ‰©å±•ä¿¡æ¯ä¿®æ”¹æ—¶è°ƒç”¨ï¼‰.
    /// </summary>
    public async Task<int> CreateNewVersionAsync(
        string productSpecId, 
        string versionDescription = null)
    {
        // 1. è·å–å½“å‰ç‰ˆæœ¬å·
        var currentVersion = await GetCurrentVersionAsync(productSpecId);
        var newVersion = currentVersion + 1;

        // 2. å°†å½“å‰ç‰ˆæœ¬æ ‡è®°ä¸ºéå½“å‰ç‰ˆæœ¬
        await _versionRepository
            .Updateable()
            .SetColumns(v => new ProductSpecVersionEntity { IsCurrent = 0 })
            .Where(v => v.ProductSpecId == productSpecId && v.IsCurrent == 1)
            .ExecuteCommandAsync();

        // 3. åˆ›å»ºæ–°ç‰ˆæœ¬è®°å½•
        var newVersionEntity = new ProductSpecVersionEntity
        {
            Id = Guid.NewGuid().ToString(),
            ProductSpecId = productSpecId,
            Version = newVersion,
            VersionName = $"v{newVersion}.0",
            VersionDescription = versionDescription,
            IsCurrent = 1,
            CreatorTime = DateTime.Now
        };
        await _versionRepository.InsertAsync(newVersionEntity);

        // 4. å¤åˆ¶å½“å‰ç‰ˆæœ¬çš„å±æ€§åˆ°æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœéœ€è¦ä¿ç•™å†å²å±æ€§ï¼‰
        // æ³¨æ„ï¼šè¿™é‡Œå¯ä»¥é€‰æ‹©åªå¤åˆ¶ï¼Œæˆ–è€…è®©ç”¨æˆ·é‡æ–°è®¾ç½®æ‰€æœ‰å±æ€§
        await CopyAttributesToNewVersionAsync(productSpecId, currentVersion, newVersion);

        return newVersion;
    }

    /// <summary>
    /// å¤åˆ¶å±æ€§åˆ°æ–°ç‰ˆæœ¬.
    /// </summary>
    private async Task CopyAttributesToNewVersionAsync(
        string productSpecId, 
        int sourceVersion, 
        int targetVersion)
    {
        var sourceAttributes = await _attributeRepository
            .AsQueryable()
            .Where(a => a.ProductSpecId == productSpecId 
                && a.Version == sourceVersion 
                && a.DeleteMark == null)
            .ToListAsync();

        var newAttributes = sourceAttributes.Select(a => new ProductSpecAttributeEntity
        {
            Id = Guid.NewGuid().ToString(),
            ProductSpecId = a.ProductSpecId,
            AttributeName = a.AttributeName,
            AttributeKey = a.AttributeKey,
            ValueType = a.ValueType,
            AttributeValue = a.AttributeValue,
            Unit = a.Unit,
            Precision = a.Precision,
            SortCode = a.SortCode,
            Version = targetVersion,
            VersionCreateTime = DateTime.Now,
            CreatorTime = DateTime.Now
        }).ToList();

        await _attributeRepository.InsertRangeAsync(newAttributes);
    }

    /// <summary>
    /// è·å–æŒ‡å®šç‰ˆæœ¬çš„æ‰©å±•å±æ€§.
    /// </summary>
    public async Task<List<ProductSpecAttributeEntity>> GetAttributesByVersionAsync(
        string productSpecId, 
        int? version = null)
    {
        // å¦‚æœæ²¡æœ‰æŒ‡å®šç‰ˆæœ¬ï¼Œä½¿ç”¨å½“å‰ç‰ˆæœ¬
        if (!version.HasValue)
        {
            version = await GetCurrentVersionAsync(productSpecId);
        }

        return await _attributeRepository
            .AsQueryable()
            .Where(a => a.ProductSpecId == productSpecId 
                && a.Version == version.Value 
                && a.DeleteMark == null)
            .OrderBy(a => a.SortCode)
            .ToListAsync();
    }

    /// <summary>
    /// è·å–æ‰€æœ‰ç‰ˆæœ¬åˆ—è¡¨.
    /// </summary>
    public async Task<List<ProductSpecVersionEntity>> GetVersionListAsync(string productSpecId)
    {
        return await _versionRepository
            .AsQueryable()
            .Where(v => v.ProductSpecId == productSpecId && v.DeleteMark == null)
            .OrderByDescending(v => v.Version)
            .ToListAsync();
    }
}
```

### 2. ä¿®æ”¹ IntermediateDataServiceï¼ˆç”Ÿæˆä¸­é—´æ•°æ®æ—¶è®°å½•ç‰ˆæœ¬ï¼‰

```csharp
/// <summary>
/// ä»åŸå§‹æ•°æ®ç”Ÿæˆä¸­é—´æ•°æ®.
/// </summary>
public IntermediateDataEntity GenerateIntermediateData(
    RawDataEntity rawData,
    ProductSpecEntity productSpec,
    List<int> detectionColumns,
    int layers,
    decimal length,
    decimal density
)
{
    var entity = new IntermediateDataEntity
    {
        // ... ç°æœ‰å­—æ®µ ...
        
        // è®°å½•ä½¿ç”¨çš„äº§å“è§„æ ¼ç‰ˆæœ¬å·
        ProductSpecVersion = await _productSpecVersionService
            .GetCurrentVersionAsync(productSpec.Id)
    };

    // ... å…¶ä»–è®¡ç®—é€»è¾‘ ...
    
    return entity;
}
```

### 3. ä¿®æ”¹è®¡ç®—é€»è¾‘ï¼ˆæ ¹æ®ç‰ˆæœ¬è·å–æ‰©å±•ä¿¡æ¯ï¼‰

```csharp
/// <summary>
/// ç”Ÿæˆä¸­é—´æ•°æ®ï¼ˆä¿®æ”¹åçš„ç‰ˆæœ¬ï¼‰.
/// </summary>
public async Task<IntermediateDataGenerateOutput> Generate(
    [FromBody] IntermediateDataGenerateInput input
)
{
    // ... ç°æœ‰é€»è¾‘ ...

    // è·å–äº§å“è§„æ ¼çš„æ‰©å±•å±æ€§ï¼ˆæ ¹æ®ç‰ˆæœ¬ï¼‰
    var productSpecVersion = input.ProductSpecVersion; // å¦‚æœæŒ‡å®šäº†ç‰ˆæœ¬ï¼Œä½¿ç”¨æŒ‡å®šç‰ˆæœ¬
    var attributes = await _productSpecVersionService
        .GetAttributesByVersionAsync(productSpec.Id, productSpecVersion);

    var lengthAttr = attributes.FirstOrDefault(a => a.AttributeKey == "length");
    var layersAttr = attributes.FirstOrDefault(a => a.AttributeKey == "layers");
    var densityAttr = attributes.FirstOrDefault(a => a.AttributeKey == "density");

    // ... å…¶ä»–é€»è¾‘ ...
}
```

### 4. ä¿®æ”¹ ProductSpecServiceï¼ˆä¿å­˜æ‰©å±•ä¿¡æ¯æ—¶åˆ›å»ºæ–°ç‰ˆæœ¬ï¼‰

```csharp
/// <summary>
/// æ›´æ–°äº§å“è§„æ ¼ï¼ˆåŒ…æ‹¬æ‰©å±•å±æ€§ï¼‰.
/// </summary>
[HttpPut("{id}")]
public async Task Update(string id, [FromBody] ProductSpecCrInput input)
{
    // ... ç°æœ‰é€»è¾‘ ...

    // æ£€æŸ¥æ‰©å±•å±æ€§æ˜¯å¦æœ‰å˜æ›´
    var hasAttributeChanges = CheckAttributeChanges(id, input.Attributes);
    
    if (hasAttributeChanges)
    {
        // åˆ›å»ºæ–°ç‰ˆæœ¬
        var newVersion = await _productSpecVersionService
            .CreateNewVersionAsync(
                id, 
                $"æ‰©å±•ä¿¡æ¯æ›´æ–°ï¼š{DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        
        // æ›´æ–°æ‰©å±•å±æ€§ï¼ˆä½¿ç”¨æ–°ç‰ˆæœ¬å·ï¼‰
        await UpdateAttributesAsync(id, input.Attributes, newVersion);
    }
    else
    {
        // æ²¡æœ‰å˜æ›´ï¼Œç›´æ¥æ›´æ–°å½“å‰ç‰ˆæœ¬çš„å±æ€§
        var currentVersion = await _productSpecVersionService
            .GetCurrentVersionAsync(id);
        await UpdateAttributesAsync(id, input.Attributes, currentVersion);
    }
}

/// <summary>
/// æ£€æŸ¥æ‰©å±•å±æ€§æ˜¯å¦æœ‰å˜æ›´.
/// </summary>
private bool CheckAttributeChanges(
    string productSpecId, 
    List<ProductSpecAttributeEntity> newAttributes)
{
    // è·å–å½“å‰ç‰ˆæœ¬çš„å±æ€§
    var currentAttributes = await _productSpecVersionService
        .GetAttributesByVersionAsync(productSpecId);
    
    // æ¯”è¾ƒå±æ€§å€¼æ˜¯å¦æœ‰å˜åŒ–
    // å®ç°æ¯”è¾ƒé€»è¾‘...
    
    return hasChanges;
}
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“è¿ç§»ï¼ˆ1-2å¤©ï¼‰

1. **åˆ›å»ºç‰ˆæœ¬å¿«ç…§è¡¨**
   ```sql
   -- æ‰§è¡Œå»ºè¡¨SQL
   CREATE TABLE LAB_PRODUCT_SPEC_VERSION (...);
   ```

2. **ä¿®æ”¹æ‰©å±•å±æ€§è¡¨**
   ```sql
   -- æ·»åŠ ç‰ˆæœ¬ç›¸å…³å­—æ®µ
   ALTER TABLE LAB_PRODUCT_SPEC_ATTRIBUTE ADD COLUMN F_VERSION INT DEFAULT 1;
   ALTER TABLE LAB_PRODUCT_SPEC_ATTRIBUTE ADD COLUMN F_VERSION_CREATE_TIME DATETIME;
   ALTER TABLE LAB_PRODUCT_SPEC_ATTRIBUTE ADD COLUMN F_VERSION_DESCRIPTION VARCHAR(500);
   ```

3. **ä¿®æ”¹ä¸­é—´æ•°æ®è¡¨**
   ```sql
   -- æ·»åŠ ç‰ˆæœ¬å·å­—æ®µ
   ALTER TABLE LAB_INTERMEDIATE_DATA ADD COLUMN F_PRODUCT_SPEC_VERSION INT;
   ```

4. **æ•°æ®è¿ç§»**
   ```sql
   -- ä¸ºç°æœ‰æ•°æ®è®¾ç½®é»˜è®¤ç‰ˆæœ¬å·ï¼ˆç‰ˆæœ¬1ï¼‰
   UPDATE LAB_PRODUCT_SPEC_ATTRIBUTE SET F_VERSION = 1 WHERE F_VERSION IS NULL;
   UPDATE LAB_PRODUCT_SPEC_ATTRIBUTE SET F_VERSION_CREATE_TIME = F_CREATOR_TIME WHERE F_VERSION_CREATE_TIME IS NULL;
   
   -- ä¸ºæ¯ä¸ªäº§å“è§„æ ¼åˆ›å»ºåˆå§‹ç‰ˆæœ¬è®°å½•
   INSERT INTO LAB_PRODUCT_SPEC_VERSION (F_ID, F_PRODUCT_SPEC_ID, F_VERSION, F_IS_CURRENT, ...)
   SELECT 
       NEWID(),
       F_ID,
       1,
       1,
       ...
   FROM LAB_PRODUCT_SPEC
   WHERE F_DELETE_MARK IS NULL;
   ```

### ç¬¬äºŒé˜¶æ®µï¼šå®ä½“ç±»æ”¹é€ ï¼ˆ1å¤©ï¼‰

1. ä¿®æ”¹ `ProductSpecAttributeEntity`ï¼Œæ·»åŠ ç‰ˆæœ¬å­—æ®µ
2. åˆ›å»º `ProductSpecVersionEntity` å®ä½“ç±»
3. ä¿®æ”¹ `IntermediateDataEntity`ï¼Œæ·»åŠ ç‰ˆæœ¬å·å­—æ®µ

### ç¬¬ä¸‰é˜¶æ®µï¼šä¸šåŠ¡é€»è¾‘å®ç°ï¼ˆ2-3å¤©ï¼‰

1. åˆ›å»º `ProductSpecVersionService` æœåŠ¡ç±»
2. ä¿®æ”¹ `ProductSpecService`ï¼Œä¿å­˜æ—¶åˆ›å»ºæ–°ç‰ˆæœ¬
3. ä¿®æ”¹ `IntermediateDataService`ï¼Œç”Ÿæˆæ—¶è®°å½•ç‰ˆæœ¬å·
4. ä¿®æ”¹è®¡ç®—é€»è¾‘ï¼Œæ ¹æ®ç‰ˆæœ¬è·å–æ‰©å±•ä¿¡æ¯

### ç¬¬å››é˜¶æ®µï¼šå‰ç«¯ç•Œé¢ï¼ˆ2-3å¤©ï¼‰

1. ç‰ˆæœ¬ç®¡ç†ç•Œé¢ï¼ˆæŸ¥çœ‹å†å²ç‰ˆæœ¬ã€ç‰ˆæœ¬å¯¹æ¯”ï¼‰
2. ç‰ˆæœ¬é€‰æ‹©å™¨ï¼ˆç”Ÿæˆä¸­é—´æ•°æ®æ—¶é€‰æ‹©ç‰ˆæœ¬ï¼‰
3. ç‰ˆæœ¬å˜æ›´è®°å½•å±•ç¤º

### ç¬¬äº”é˜¶æ®µï¼šæµ‹è¯•éªŒè¯ï¼ˆ1-2å¤©ï¼‰

1. å•å…ƒæµ‹è¯•ï¼šç‰ˆæœ¬åˆ›å»ºã€ç‰ˆæœ¬æŸ¥è¯¢ã€å±æ€§å¤åˆ¶
2. é›†æˆæµ‹è¯•ï¼šç”Ÿæˆä¸­é—´æ•°æ®æ—¶ç‰ˆæœ¬è®°å½•ã€è®¡ç®—æ—¶ç‰ˆæœ¬è·å–
3. å›å½’æµ‹è¯•ï¼šç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- âœ… ä¿®æ”¹æ‰©å±•ä¿¡æ¯æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°ç‰ˆæœ¬
- âœ… ç”Ÿæˆä¸­é—´æ•°æ®æ—¶ï¼Œè®°å½•ä½¿ç”¨çš„ç‰ˆæœ¬å·
- âœ… è®¡ç®—æ—¶ï¼Œæ ¹æ®ç‰ˆæœ¬å·è·å–å¯¹åº”çš„æ‰©å±•ä¿¡æ¯
- âœ… å†å²æ•°æ®ä¸å—æ–°ç‰ˆæœ¬å½±å“ï¼ˆç»§ç»­ä½¿ç”¨æ—§ç‰ˆæœ¬ï¼‰
- âœ… æ–°æ•°æ®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
- âœ… å¯ä»¥æŸ¥çœ‹å†å²ç‰ˆæœ¬åˆ—è¡¨
- âœ… å¯ä»¥å¯¹æ¯”ä¸åŒç‰ˆæœ¬çš„å·®å¼‚

### æ€§èƒ½éªŒæ”¶
- âœ… ç‰ˆæœ¬æŸ¥è¯¢æ€§èƒ½æ»¡è¶³è¦æ±‚ï¼ˆ< 100msï¼‰
- âœ… æ‰¹é‡ç”Ÿæˆä¸­é—´æ•°æ®æ—¶ï¼Œç‰ˆæœ¬è·å–ä¸å½±å“æ€§èƒ½

### å…¼å®¹æ€§éªŒæ”¶
- âœ… æ²¡æœ‰ç‰ˆæœ¬å·çš„æ—§æ•°æ®é»˜è®¤ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… ç°æœ‰åŠŸèƒ½ä¸å—å½±å“

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. ç‰ˆæœ¬å·ç®¡ç†
- ç‰ˆæœ¬å·ä»1å¼€å§‹é€’å¢
- æ¯ä¸ªäº§å“è§„æ ¼ç‹¬ç«‹ç®¡ç†ç‰ˆæœ¬å·
- ç‰ˆæœ¬å·ä¸€æ—¦åˆ›å»ºï¼Œä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤ï¼ˆåªèƒ½æ ‡è®°ä¸ºåˆ é™¤ï¼‰

### 2. å±æ€§å¤åˆ¶ç­–ç•¥
- **ç­–ç•¥**ï¼šåˆ›å»ºæ–°ç‰ˆæœ¬æ—¶ï¼Œè‡ªåŠ¨å¤åˆ¶å½“å‰ç‰ˆæœ¬çš„æ‰€æœ‰å±æ€§
  - ä¼˜ç‚¹ï¼šç”¨æˆ·åªéœ€ä¿®æ”¹å˜æ›´çš„å±æ€§
  - ç¼ºç‚¹ï¼šå¯èƒ½å¤åˆ¶äº†ä¸éœ€è¦çš„å±æ€§ï¼ˆéœ€æä¾›æ¸…ç†æœºåˆ¶ï¼‰
  
### 3. ç‰ˆæœ¬åˆ é™¤ç­–ç•¥
- ç‰ˆæœ¬è®°å½•ä¸èƒ½ç‰©ç†åˆ é™¤ï¼Œåªèƒ½é€»è¾‘åˆ é™¤ï¼ˆæ ‡è®°åˆ é™¤ï¼‰
- å·²ä½¿ç”¨çš„ç‰ˆæœ¬ä¸èƒ½åˆ é™¤ï¼ˆæœ‰ä¸­é—´æ•°æ®å…³è”ï¼‰

### 4. æ€§èƒ½ä¼˜åŒ–
- ç‰ˆæœ¬æŸ¥è¯¢ä½¿ç”¨ç¼“å­˜ï¼ˆRedisï¼‰
- æ‰¹é‡ç”Ÿæˆä¸­é—´æ•°æ®æ—¶ï¼Œæ‰¹é‡æŸ¥è¯¢ç‰ˆæœ¬ä¿¡æ¯

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.1
**æ›´æ–°æ—¥æœŸ**ï¼š2026-01-13
**ç»´æŠ¤äººå‘˜**ï¼šAIåŠ©æ‰‹
