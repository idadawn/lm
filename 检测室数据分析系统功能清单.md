# 检测室数据分析系统功能清单

## 一、核心业务功能

### 1. 产品定义管理
**服务文件**: `ProductSpecService.cs`
- 产品规格的增删改查
- 产品规格代码唯一性校验
- 产品规格扩展属性管理
- 产品规格公共属性自动添加
- 检测列配置管理

### 2. 外观特征管理
**服务文件**: `AppearanceFeatureService.cs`
- 外观特性的增删改查
- 特性名称全局唯一性校验
- 特性与分类、等级的关联管理
- 特性关键词管理（添加、创建或添加）
- 特性匹配功能（规则引擎 + AI混合识别）
  - 规则引擎匹配（优先级1）
  - AI分析匹配（优先级2）
  - 文本模糊匹配（优先级3）
- 批量匹配功能
- 人工修正记录保存

### 3. 原始数据管理
**服务文件**: `RawDataService.cs`
- Excel文件预览（支持增量导入，记住上次位置）
- Excel文件导入（支持动态检测列，JSON字段存储）
- 原始数据列表查询（支持多字段排序）
- 原始数据详情查看
- 原始数据删除
- 导入日志查询
- 炉号解析（使用FurnaceNoHelper）
- 产品规格自动识别
- 外观特性自动匹配（特性汉字匹配）
- 错误报告生成

### 4. 中间数据表管理
**服务文件**: `IntermediateDataService.cs`
- 中间数据列表查询（支持分页、筛选、排序）
- 中间数据详情查看
- 中间数据生成（从原始数据计算）
  - 带厚计算
  - 叠片系数计算
  - 密度计算
  - 带型计算
  - 异常检测（头尾数据差值>1.5标红）
- 性能数据更新（PerfSsPower、PerfPsLoss、PerfHc等）
- 外观数据更新（Toughness、FishScale、MidSi等）
- 基础信息更新（DateMonth、MagneticResult等）
- 批量删除
- 产品规格选项查询

## 二、辅助管理功能

### 5. 外观特性大类管理
**服务文件**: `AppearanceFeatureCategoryService.cs`
- 特性大类的增删改查
- 树形结构管理（支持多级分类）
- 分类路径自动计算（RootId、Path字段）
- 分类下特性数量统计
- 防止循环引用
- 删除前检查（子分类、特性关联）

### 6. 外观特性等级管理
**服务文件**: `AppearanceFeatureLevelService.cs`
- 特性等级的增删改查
- 等级名称唯一性校验
- 默认等级管理（只能有一个默认等级）
- 启用/禁用状态管理
- 获取启用的等级列表（用于程度词识别）

### 7. 产品规格扩展属性管理
**服务文件**: `ProductSpecAttributeService.cs`
- 根据产品规格ID查询属性列表
- 批量保存属性
- 根据产品规格ID删除属性

### 8. 产品规格公共属性管理
**服务文件**: `ProductSpecPublicAttributeService.cs`
- 公共属性的增删改查
- 属性键名唯一性校验
- 自动应用到所有产品规格
- 手动应用到所有产品规格

## 三、智能分析功能

### 9. 外观特性分析服务
**服务文件**: `AppearanceAnalysisService.cs`
- AI分析外观特性（调用AI模块）
- 从数据库动态获取特性、分类、等级数据
- 将AI结果转换为业务层DTO格式

### 10. 外观特性规则匹配器
**服务文件**: `AppearanceFeatureRuleMatcher.cs`
- 规则引擎匹配（名称匹配、关键词匹配、程度词识别）
- 支持1:n匹配（一个输入文本可匹配多个特性）
- 程度词识别（微、轻、重等）
- 分类路径构建

### 11. 特性学习服务（闭环学习机制）
**服务文件**: `FeatureLearningService.cs`
- 关键词建议（从人工修正记录中提取）
- 批量应用关键词建议
- 学习统计信息（总修正次数、准确率等）
- 人工修正列表查询
- 修正记录确认（添加为关键词）
- 修正记录更新
- 修正记录删除

## 四、数据导入功能

### 12. 原始数据导入会话服务
**服务文件**: `RawDataImportSessionService.cs`
- 分步导入流程管理
  - 步骤1：上传和解析
  - 步骤2：产品规格匹配
  - 步骤3：外观特性匹配
  - 步骤4：审核
  - 步骤5：完成导入
- 导入会话创建和管理
- 增量导入支持（跳过已导入行）
- 增量导入一致性校验（对比最后N行哈希值）
- 文件保存（使用FileManager）
- 产品规格匹配查询和更新
- 外观特性匹配查询和更新
- 审核数据查询
- 完成导入（自动生成中间数据）

### 13. 原始数据校验服务
**服务文件**: `RawDataValidationService.cs`
- 基础字段校验（日期、炉号、宽度、带材重量）
- 数值范围校验
- 炉号格式校验
- 数据完整性校验（产品规格、有效性等）

## 五、技术特性

### 数据存储
- 支持动态检测列（JSON字段存储，不限制为22列）
- 向后兼容Detection1-22字段
- 软删除机制（DeleteMark字段）

### 匹配策略
- 规则引擎优先（最快、最准）
- AI分析补位（处理复杂描述）
- 文本模糊匹配兜底

### 导入策略
- 全量导入
- 增量导入（记住上次位置）
- 覆盖导入

### 学习机制
- 人工修正记录保存
- 关键词自动提取
- 准确率统计

## 六、API路由汇总

| 功能模块 | 路由前缀 | 说明 |
|---------|---------|------|
| 产品规格 | `/api/lab/product-specs` | 产品定义管理 |
| 产品规格属性 | `/api/lab/product-spec-attributes` | 扩展属性管理 |
| 产品规格公共属性 | `/api/lab/product-spec-public-attributes` | 公共属性管理 |
| 外观特性 | `/api/lab/appearance-features` | 特性管理 |
| 外观特性大类 | `/api/lab/appearance-feature-categories` | 分类管理 |
| 外观特性等级 | `/api/lab/appearance-feature-levels` | 等级管理 |
| 原始数据 | `/api/lab/raw-data` | 原始数据管理 |
| 原始数据导入会话 | `/api/lab/raw-data-import-session` | 分步导入 |
| 中间数据 | `/api/lab/intermediate-data` | 中间数据管理 |
| 特性学习 | `/api/lab/feature-learning` | 学习机制 |

## 七、数据流转

```
Excel文件
  ↓
原始数据导入（RawDataService / RawDataImportSessionService）
  ↓
炉号解析 → 产品规格识别 → 外观特性匹配
  ↓
中间数据生成（IntermediateDataService）
  ↓
性能数据录入 → 外观数据录入 → 基础信息录入
  ↓
数据分析与统计
```

## 八、关键算法

1. **产品规格识别算法**
   - 根据检测列数据匹配产品规格配置
   - 支持多检测列配置（如"13,15,18,22"）

2. **外观特性匹配算法**
   - 规则引擎：名称精确匹配、关键词匹配、程度词识别
   - AI分析：调用AI模块进行语义分析
   - 模糊匹配：文本包含匹配

3. **中间数据计算算法**
   - 带厚 = 检测值 / 层数
   - 密度 = 一米带材重量 / (带宽 * 平均厚度/10)
   - 叠片系数 = 四米带材重量 / (带宽 * 长度 * 平均厚度 * 密度 * 0.0000001)
   - 带型 = IF(AVG(中间段) < AVG(两侧段), MIN(中间段) - MAX(两侧段), MAX(中间段) - MIN(两侧段))

4. **增量导入一致性校验**
   - 对比最后N行数据的MD5哈希值
   - 确保文件未被修改

## 九、数据表结构

### 1. 核心业务表

#### 1.1 LAB_RAW_DATA（原始数据表）
**说明**: 存储从Excel导入的原始检测数据

**主要字段**:
- `F_PROD_DATE`: 生产日期
- `F_FURNACE_NO`: 原始炉号（包含特性汉字）
- `F_LINE_NO`: 产线（从炉号解析）
- `F_SHIFT`: 班次（从炉号解析）
- `F_FURNACE_NO_PARSED`: 炉号（解析后的数字部分）
- `F_COIL_NO`: 卷号
- `F_SUBCOIL_NO`: 分卷号
- `F_FEATURE_SUFFIX`: 特性描述（原始特性汉字）
- `F_WIDTH`: 宽度
- `F_COIL_WEIGHT`: 带材重量
- `F_PRODUCT_SPEC_ID`: 产品规格ID（关联）
- `F_DETECTION_DATA`: 检测数据（JSON格式，动态列）
- `F_DETECTION_1` ~ `F_DETECTION_22`: 检测列1-22（向后兼容）
- `F_APPEARANCE_FEATURE_IDS`: 匹配后的特性ID列表（JSON数组）
- `F_IS_VALID_DATA`: 有效数据标识（0/1）
- `F_IMPORT_SESSION_ID`: 导入会话ID
- `F_IMPORT_STATUS`: 导入状态（0-成功，1-失败）
- `F_IMPORT_ERROR`: 导入错误信息

**索引**:
- `idx_prod_date`: 生产日期索引
- `idx_furnace_no`: 炉号索引
- `idx_product_spec_id`: 产品规格ID索引
- `idx_import_session_id`: 导入会话ID索引
- `idx_is_valid_data`: 有效数据标识索引

#### 1.2 LAB_INTERMEDIATE_DATA（中间数据表）
**说明**: 存储从原始数据计算生成的中间数据

**主要字段**:
- `F_RAW_DATA_ID`: 原始数据ID（关联）
- `F_PROD_DATE`: 生产日期
- `F_DATE_MONTH`: 日期月份（yyyy-MM格式）
- `F_SPRAY_NO`: 喷次（产线+班次+日期+炉号组合）
- `F_FURNACE_NO`: 原始炉号（去掉特性汉字）
- `F_PRODUCT_SPEC_ID`: 产品规格ID（关联）
- `F_ONE_METER_WEIGHT`: 一米带材重量(g)
- `F_FOUR_METER_WEIGHT`: 四米带材重量(g)
- `F_STRIP_WIDTH`: 带宽(mm)
- `F_THICKNESS_RANGE`: 带厚范围（最小值～最大值）
- `F_THICKNESS_MIN/MAX/DIFF`: 带厚最小值/最大值/极差
- `F_AVG_THICKNESS`: 平均厚度
- `F_DENSITY`: 密度(g/cm³)
- `F_LAMINATION_FACTOR`: 叠片系数
- `F_STRIP_TYPE`: 带型
- `F_SEGMENT_TYPE`: 分段类型（前端/中端/后端）
- `F_THICKNESS_1` ~ `F_THICKNESS_10`: 带厚分布1-10
- `F_THICKNESS_ABNORMAL`: 带厚异常标记（JSON数组）
- `F_LAMINATION_DIST_1` ~ `F_LAMINATION_DIST_10`: 叠片系数分布1-10
- `F_PERF_SS_POWER`: 1.35T 50Hz Ss激磁功率
- `F_PERF_PS_LOSS`: 1.35T 50Hz Ps铁损
- `F_PERF_HC`: 1.35T 50Hz Hc
- `F_PERF_AFTER_SS_POWER/PS_LOSS/HC`: 刻痕后性能数据
- `F_TOUGHNESS`: 韧性
- `F_FISH_SCALE`: 鱼鳞纹
- `F_MID_SI/MID_B`: 中Si/中B
- `F_LEFT_PATTERN/MID_PATTERN/RIGHT_PATTERN`: 左/中/右花纹
- `F_MAGNETIC_RESULT`: 磁性能判定
- `F_THICKNESS_RESULT`: 厚度判定
- `F_LAMINATION_RESULT`: 叠片系数判定

**索引**:
- `idx_raw_data_id`: 原始数据ID索引
- `idx_prod_date`: 生产日期索引
- `idx_product_spec_id`: 产品规格ID索引

#### 1.3 LAB_PRODUCT_SPEC（产品规格表）
**说明**: 存储产品规格定义

**主要字段**:
- `F_CODE`: 规格代码（如120/142/170/213，唯一）
- `F_NAME`: 规格名称
- `F_DETECTION_COLUMNS`: 检测列配置（如"13,15,18,22"）
- `F_DESCRIPTION`: 描述
- `F_SORTCODE`: 排序码

#### 1.4 LAB_APPEARANCE_FEATURE（外观特性表）
**说明**: 存储外观特性定义

**主要字段**:
- `F_CATEGORY_ID`: 特性大类ID（外键，关联LAB_APPEARANCE_FEATURE_CATEGORY）
- `F_NAME`: 特性名称（如"脆"，全局唯一）
- `F_SEVERITY_LEVEL_ID`: 特性等级ID（外键，关联LAB_APPEARANCE_FEATURE_LEVEL）
- `F_KEYWORDS`: 关键字列表（JSON数组，用于精确匹配）
- `F_DESCRIPTION`: 描述
- `F_SORTCODE`: 排序码

**唯一性约束**: 特性名称全局唯一

### 2. 辅助配置表

#### 2.1 LAB_PRODUCT_SPEC_ATTRIBUTE（产品规格扩展属性表）
**说明**: 存储产品规格的扩展属性（如长度、层数、密度）

**主要字段**:
- `F_PRODUCT_SPEC_ID`: 产品规格ID（外键）
- `F_ATTRIBUTE_NAME`: 属性名称（如"长度"）
- `F_ATTRIBUTE_KEY`: 属性键名（如"length"，唯一）
- `F_VALUE_TYPE`: 属性值类型（decimal/int/text）
- `F_ATTRIBUTE_VALUE`: 属性值（字符串存储）
- `F_UNIT`: 属性单位（如"m"、"mm"）
- `F_PRECISION`: 精度（小数位数）
- `F_SORTCODE`: 排序码

#### 2.2 LAB_PRODUCT_SPEC_PUBLIC_ATTRIBUTE（产品规格公共属性表）
**说明**: 存储所有产品规格共享的公共属性定义

**主要字段**:
- `F_ATTRIBUTE_NAME`: 属性名称
- `F_ATTRIBUTE_KEY`: 属性键名（唯一）
- `F_VALUE_TYPE`: 属性值类型
- `F_DEFAULT_VALUE`: 默认值
- `F_UNIT`: 属性单位
- `F_PRECISION`: 精度
- `F_SORTCODE`: 排序码

#### 2.3 LAB_APPEARANCE_FEATURE_CATEGORY（外观特性大类表）
**说明**: 存储外观特性分类（支持树形结构）

**主要字段**:
- `F_NAME`: 大类名称（唯一，同一父级下）
- `F_DESCRIPTION`: 描述
- `F_PARENTID`: 父级分类ID（"-1"表示顶级分类）
- `F_ROOTID`: 根分类ID（最顶层分类的ID）
- `F_PATH`: 分类路径（从根到当前，逗号分隔ID）
- `F_SORTCODE`: 排序码

**特性**: 支持多级分类，自动计算路径和根分类

#### 2.4 LAB_APPEARANCE_FEATURE_LEVEL（外观特性等级表）
**说明**: 存储外观特性等级定义（如微、轻、重）

**主要字段**:
- `F_NAME`: 等级名称（唯一，如"微"、"轻微"、"严重"）
- `F_DESCRIPTION`: 等级描述
- `F_ENABLED`: 是否启用（用于程度词识别）
- `F_ISDEFAULT`: 是否默认（只能有一个默认等级）
- `F_SORTCODE`: 排序码

### 3. 导入管理表

#### 3.1 lab_raw_data_import_session（导入会话表）
**说明**: 存储分步导入的会话信息

**主要字段**:
- `F_FILE_NAME`: 文件名
- `F_SOURCE_FILE_ID`: Excel源文件ID
- `F_IMPORT_STRATEGY`: 导入策略（incremental/full/overwrite/deduplicate）
- `F_CURRENT_STEP`: 当前步骤（0-4）
- `F_TOTAL_ROWS`: 总行数
- `F_VALID_DATA_ROWS`: 有效数据行数
- `F_STATUS`: 状态（pending/in_progress/completed/failed/cancelled）

**索引**:
- `idx_status`: 状态索引
- `idx_creator`: 创建人索引

#### 3.2 lab_raw_data_import_log（导入日志表）
**说明**: 存储每次导入的日志记录

**主要字段**:
- `F_FILE_NAME`: 文件名
- `F_TOTAL_ROWS`: 总行数（Excel行数）
- `F_SUCCESS_COUNT`: 成功行数
- `F_FAIL_COUNT`: 失败行数
- `F_STATUS`: 导入状态（success/partial/failed）
- `F_IMPORT_TIME`: 导入时间
- `F_SOURCE_FILE_ID`: Excel源文件ID
- `F_VALID_DATA_COUNT`: 有效数据行数
- `F_LAST_ROWS_HASH`: 最后N行数据哈希值（用于增量导入校验）
- `F_LAST_ROWS_COUNT`: 记录的最后行数（默认3行）
- `F_IMPORT_SESSION_ID`: 导入会话ID

### 4. 学习机制表

#### 4.1 LAB_APPEARANCE_FEATURE_CORRECTION（外观特性修正记录表）
**说明**: 存储人工修正记录，用于闭环学习

**主要字段**:
- `F_INPUT_TEXT`: 原始输入文本
- `F_AUTO_MATCHED_FEATURE_ID`: 自动匹配的特征ID
- `F_CORRECTED_FEATURE_ID`: 人工修正后的特征ID
- `F_MATCH_MODE`: 匹配模式（auto/manual/create/ai_proposal）
- `F_SCENARIO`: 使用场景（test/import）
- `F_REMARK`: 备注
- `F_STATUS`: 状态（Pending/Confirmed/Ignored）

### 5. 数据表关系图

```
LAB_PRODUCT_SPEC (产品规格)
  ├── LAB_PRODUCT_SPEC_ATTRIBUTE (扩展属性) [1:N]
  └── LAB_PRODUCT_SPEC_PUBLIC_ATTRIBUTE (公共属性) [N:1]

LAB_APPEARANCE_FEATURE_CATEGORY (特性大类) [树形结构]
  └── LAB_APPEARANCE_FEATURE (外观特性) [1:N]
      └── LAB_APPEARANCE_FEATURE_LEVEL (特性等级) [N:1]

LAB_RAW_DATA (原始数据)
  ├── LAB_PRODUCT_SPEC [N:1]
  ├── LAB_APPEARANCE_FEATURE [N:N] (通过JSON字段存储ID列表)
  ├── lab_raw_data_import_session [N:1]
  └── LAB_INTERMEDIATE_DATA [1:1]

LAB_INTERMEDIATE_DATA (中间数据)
  └── LAB_RAW_DATA [1:1]

LAB_APPEARANCE_FEATURE_CORRECTION (修正记录)
  └── LAB_APPEARANCE_FEATURE [N:1]
```

### 6. JSON字段格式说明

#### 6.1 F_DETECTION_DATA（检测数据）
**表**: LAB_RAW_DATA
**格式**: `{"1": 123.45, "2": 234.56, "3": 345.67, ...}`
**说明**: 键为检测列序号（字符串），值为检测数据（数字）
**示例**: `{"1": 123.45, "2": 234.56, "3": 345.67, "4": 456.78}`

#### 6.2 F_APPEARANCE_FEATURE_IDS（特性ID列表）
**表**: LAB_RAW_DATA, LAB_INTERMEDIATE_DATA
**格式**: `["feature-id-1", "feature-id-2", "feature-id-3"]`
**说明**: 特性ID数组，一个特性汉字可以匹配多个特性（1:n关系）
**示例**: `["appearance-feature-001", "appearance-feature-002"]`

#### 6.3 F_THICKNESS_ABNORMAL（带厚异常标记）
**表**: LAB_INTERMEDIATE_DATA
**格式**: `["1", "3", "5"]`
**说明**: 需要红色标注的带厚序号数组
**示例**: `["1", "3", "5"]`

#### 6.4 F_KEYWORDS（关键词列表）
**表**: LAB_APPEARANCE_FEATURE
**格式**: `["脆", "碎", "易断", "发脆"]`
**说明**: 关键词JSON数组，用于精确匹配
**示例**: `["脆", "碎", "易断"]`

### 7. 数据表设计特点

1. **多租户支持**: 所有表都包含`F_TENANTID`字段，支持多租户隔离
2. **软删除机制**: 所有表都包含`F_DeleteMark`字段，支持软删除
3. **JSON字段**: 使用MySQL 5.7+的JSON类型，支持动态列和复杂数据结构
4. **向后兼容**: 原始数据表保留Detection1-22字段，但建议使用JSON字段
5. **索引优化**: 关键查询字段都建立了索引，提升查询性能
6. **关联关系**: 通过外键和JSON字段实现灵活的关联关系

## 十、待完善功能

1. 数据统计分析报表
2. 数据导出功能
3. 批量操作优化
4. 性能监控和优化
5. 更多AI分析场景支持
